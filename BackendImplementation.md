# Backend Implementation (FastAPI)

This backend follows the architecture described in `Docs/Backend.md` and `Docs/Architecture.md`, implemented with FastAPI and the agreed data formats (full dx/dy as base64 PNG).

## Stack & Layout
- Stack: FastAPI, NumPy, OpenCV (headless), SciPy, Pillow, uvicorn.
- Key entrypoint: `backend/main.py` (app factory + router registration).
- Structure:
  - `backend/api/` – FastAPI routers (`routes_images`, `routes_gradients`, `routes_reconstruct`, `routes_analysis`).
  - `backend/core/` – pure logic: image storage, gradient ops, Poisson solver, synthetic detector.
  - `backend/models/` – DTOs and `config.py`.
  - `backend/static/` – persisted artifacts
    - `images/` uploads
    - `gradients/` dx/dy/mag visuals
    - `reconstructions/` outputs from `/api/reconstruct`
    - `analysis/` heatmaps from `/api/analyze`

## How the pipeline works
1) **Upload (`POST /api/images`)**
   - Reads file bytes, enforces size and dimension limits (`MAX_IMAGE_SIZE_MB`, `MAX_IMAGE_DIMENSION`).
   - Saves as PNG in `static/images/{imageId}.png`, returns `imageId`, width, height.

2) **Gradients (`GET /api/gradients?imageId=`)**
   - Loads image as float32 `[0,1]`.
   - Computes Sobel gradients `dx`, `dy` (grayscale).
   - Builds visuals:
     - `dx` / `dy`: signed field normalized to 0–255 (centered at 128).
     - `mag`: gradient magnitude normalized to 0–255.
   - Saves to `static/gradients/{imageId}_{dx,dy,mag}.png`; returns their URLs and image meta.

3) **Reconstruction (`POST /api/reconstruct`)**
   - Body (`ReconstructionRequest`):
     - `imageId` (existing upload)
     - `editedDx`, `editedDy`: base64 PNG, **grayscale**, mapping to `[-1, 1]` via `(pixel/255 - 0.5) * 2`.
     - `mode` (currently informational; solver runs full-frame).
   - Validates shape vs original image.
   - Runs Poisson solver (`poisson_solver.reconstruct_image_from_gradients`):
     - Forms divergence from `dx`, `dy`.
     - Solves with discrete sine transform (DST) and optional boundary from the original image.
   - Saves RGB reconstruction to `static/reconstructions/{imageId}_recon.png`; returns URL.

4) **Analysis (`POST /api/analyze`)**
   - Computes gradients as in step 2.
   - Metrics (lightweight heuristics for didactic UI):
     - `edgeConsistency`: inverse-tanh of gradient std.
     - `smoothnessScore`: inversely proportional to Laplacian variance.
     - `textureWeirdness`: normalized mean abs Laplacian.
   - Heatmap: normalized magnitude, colorized with OpenCV `COLORMAP_INFERNO`, saved to `static/analysis/{imageId}_heatmap.png`.
   - Returns scores and heatmap URL.

## Data models (Pydantic)
- `UploadImageResponse`: `imageId`, `width`, `height`
- `GradientsResponse`: `imageId`, `width`, `height`, `dxUrl`, `dyUrl`, `magnitudeUrl`
- `ReconstructionRequest`: `imageId`, `editedDx`, `editedDy`, `mode`
- `ReconstructionResponse`: `imageId`, `reconstructedUrl`
- `AnalysisRequest`: `imageId`
- `AnalysisResponse`: `imageId`, `scores`, `heatmapUrl`
- Errors share `{ "error": { code, message } }`.

## Gradient encoding contract
- Incoming edited gradients: base64 PNG, grayscale. Value decoding: `float_field = (pixel/255 - 0.5) * 2`, yielding `[-1,1]`.
- Visuals generated by the backend are for display only; reconstruction expects the normalized field above.

## Configuration
- `models/config.py` centralizes paths (`IMAGE_DIR`, `GRADIENT_DIR`, `RECON_DIR`, `ANALYSIS_DIR`), limits (`MAX_IMAGE_SIZE_MB`, `MAX_IMAGE_DIMENSION`), and Poisson epsilon.
- `ensure_directories()` is called during app creation.

## Running locally
```bash
cd "/Users/denniszink/Library/Mobile Documents/com~apple~CloudDocs/Studium /Master/Semester 1/Bildverarbeitung/Exercises/Exercise03/Project02"
python -m venv .venv && source .venv/bin/activate
pip install -r backend/requirements.txt
uvicorn backend.main:app --reload --port 8000
```
- Static files served under `/static`. Example reconstructed URL: `/static/reconstructions/{id}_recon.png`.
- CORS is open (`*`) for ease of connecting the Next.js frontend.

## Notes & limitations
- Gradients use Sobel on grayscale; reconstruction outputs grayscale replicated to RGB.
- Poisson solver is DST-based; `POISSON_EPS` prevents division by zero. For very large images, consider tiling or GPU alternatives.
- The analysis metrics are heuristic and intended for UI visualization, not as production-grade synthetic detectors.

